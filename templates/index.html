<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期货价格监测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        light: '#F2F3F5',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-grid {
                background-image: linear-gradient(to right, rgba(156, 163, 175, 0.1) 1px, transparent 1px),
                                  linear-gradient(to bottom, rgba(156, 163, 175, 0.1) 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-chart-line text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">期货价格监测系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 bg-gray-100 rounded-full px-4 py-1.5">
                    <i class="fa-solid fa-clock text-info"></i>
                    <span id="current-time" class="text-sm">加载中...</span>
                </div>
                <button id="refresh-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                    <i class="fa-solid fa-refresh mr-2"></i>
                    <span>刷新数据</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 transform hover:scale-[1.02] transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">总监测品种</h3>
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                        <i class="fa-solid fa-list text-primary"></i>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <p class="text-3xl font-bold text-gray-800" id="total-instruments">22</p>
                    <p class="text-sm text-green-500 flex items-center">
                        <i class="fa-solid fa-arrow-up mr-1"></i> 0%
                    </p>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 transform hover:scale-[1.02] transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">活跃监测</h3>
                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center">
                        <i class="fa-solid fa-bolt text-secondary"></i>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <p class="text-3xl font-bold text-gray-800" id="active-monitors">0</p>
                    <p class="text-sm text-green-500 flex items-center">
                        <i class="fa-solid fa-arrow-up mr-1"></i> 0%
                    </p>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 transform hover:scale-[1.02] transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">预警数量</h3>
                    <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center">
                        <i class="fa-solid fa-exclamation-triangle text-warning"></i>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <p class="text-3xl font-bold text-gray-800" id="alert-count">0</p>
                    <p class="text-sm text-red-500 flex items-center">
                        <i class="fa-solid fa-arrow-up mr-1"></i> 0%
                    </p>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa-solid fa-sliders text-primary mr-2"></i>
                全局控制
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-700">自动刷新</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-700">价格预警通知</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="price-alert-notify" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-700">ATR预警通知</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="atr-alert-notify" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-700">形态预警通知</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="pattern-alert-notify" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
            </div>
        </div>

        <!-- 表格区域 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fa-solid fa-table text-primary mr-2"></i>
                    期货监测数据
                </h2>
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="搜索品种..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 w-full md:w-64">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="toggle-all-price" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors">
                        价格开关
                    </button>
                    <button id="toggle-all-atr" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors">
                        ATR开关
                    </button>
                    <button id="toggle-all-pattern" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors">
                        形态开关
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto scrollbar-hide">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-4">序号</th>
                            <th scope="col" class="px-6 py-4">品种</th>
                            <th scope="col" class="px-6 py-4">监测价格</th>
                            <th scope="col" class="px-6 py-4">价格监测开关</th>
                            <th scope="col" class="px-6 py-4">ATR监测方向</th>
                            <th scope="col" class="px-6 py-4">ATR监测开关</th>
                            <th scope="col" class="px-6 py-4">形态监测方向</th>
                            <th scope="col" class="px-6 py-4">形态监测开关</th>
                            <th scope="col" class="px-6 py-4">当前状态</th>
                        </tr>
                    </thead>
                    <tbody id="futures-table-body">
                        <!-- 表格内容将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-gray-50 flex justify-between items-center border-t border-gray-100">
                <div class="text-sm text-gray-600">
                    显示 <span id="showing-range">1-22</span> 条，共 <span id="total-items">22</span> 条
                </div>
                <div class="flex space-x-1">
                    <button class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-200 hover:bg-gray-100 text-gray-600">
                        <i class="fa-solid fa-chevron-left text-xs"></i>
                    </button>
                    <button class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary text-white">1</button>
                    <button class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-200 hover:bg-gray-100 text-gray-600">
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-chart-bar text-primary mr-2"></i>
                    预警类型分布
                </h2>
                <div class="h-80">
                    <canvas id="alert-types-chart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-chart-area text-primary mr-2"></i>
                    预警趋势
                </h2>
                <div class="h-80">
                    <canvas id="alert-trend-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-chart-line text-primary text-xl"></i>
                        <span class="text-lg font-bold">期货价格监测系统</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-2">实时监测期货市场动态，及时提供价格预警</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-question-circle"></i>
                        <span class="ml-1">帮助中心</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-file-text"></i>
                        <span class="ml-1">使用文档</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-envelope"></i>
                        <span class="ml-1">联系我们</span>
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-6 pt-6 text-center text-gray-500 text-sm">
                &copy; 2025 期货价格监测系统 | 保留所有权利
            </div>
        </div>
    </footer>

    <!-- 通知组件 -->
    <div id="notification-container" class="fixed top-20 right-4 z-50 max-w-xs"></div>

    <script>
        let instruments = [];
        let config = {};
        let alertTypesChart;
        let alertTrendChart;
        
        // 连接WebSocket
        const socket = io();
        
        // 初始数据
        socket.on('initial_data', (data) => {
            instruments = data.instruments;
            config = data.config;
            initUI();
            updateTable();
            updateDashboardStats();
            initCharts();
            updateCharts();
            startClock();
        });
        
        // 数据更新
        socket.on('update_data', (data) => {
            instruments = data.instruments;
            updateTable();
            updateDashboardStats();
            updateCharts();
        });
        
        // 接收预警
        socket.on('alert', (data) => {
            showNotification(data.message, data.type);
        });
        
        // 初始化UI
        function initUI() {
            // 设置配置选项
            document.getElementById('auto-refresh').checked = config.auto_refresh;
            document.getElementById('price-alert-notify').checked = config.price_alert_notify;
            document.getElementById('atr-alert-notify').checked = config.atr_alert_notify;
            document.getElementById('pattern-alert-notify').checked = config.pattern_alert_notify;
            
            // 添加事件监听
            document.getElementById('auto-refresh').addEventListener('change', saveConfig);
            document.getElementById('price-alert-notify').addEventListener('change', saveConfig);
            document.getElementById('atr-alert-notify').addEventListener('change', saveConfig);
            document.getElementById('atr-alert-notify').addEventListener('change', saveConfig);
            document.getElementById('pattern-alert-notify').addEventListener('change', saveConfig);
            
            // 全局控制按钮
            document.getElementById('refresh-btn').addEventListener('click', () => {
                fetch('/api/instruments')
                    .then(response => response.json())
                    .then(data => {
                        instruments = data;
                        updateTable();
                        updateDashboardStats();
                        updateCharts();
                        showNotification('数据已刷新', 'success');
                    })
                    .catch(error => {
                        console.error('刷新数据失败:', error);
                        showNotification('刷新数据失败', 'danger');
                    });
            });
            
            // 全局开关按钮
            document.getElementById('toggle-all-price').addEventListener('click', toggleAllPriceMonitors);
            document.getElementById('toggle-all-atr').addEventListener('click', toggleAllAtrMonitors);
            document.getElementById('toggle-all-pattern').addEventListener('click', toggleAllPatternMonitors);
            
            // 搜索功能
            document.getElementById('search-input').addEventListener('input', filterTable);
        }
        
        // 保存配置
        function saveConfig() {
            config = {
                auto_refresh: document.getElementById('auto-refresh').checked,
                price_alert_notify: document.getElementById('price-alert-notify').checked,
                atr_alert_notify: document.getElementById('atr-alert-notify').checked,
                pattern_alert_notify: document.getElementById('pattern-alert-notify').checked
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                console.log('配置已保存:', data);
            })
            .catch(error => {
                console.error('保存配置失败:', error);
            });
        }
        
        // 更新表格
        function updateTable() {
            const tableBody = document.getElementById('futures-table-body');
            tableBody.innerHTML = '';
            
            instruments.forEach((instrument, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50 transition-colors' : 'bg-gray-50 hover:bg-gray-100 transition-colors';
                
                // 设置状态样式
                let statusClass = '';
                if (instrument.status.includes('价格预警')) {
                    statusClass = 'bg-red-50 text-red-600 border-l-4 border-red-400';
                } else if (instrument.status.includes('ATR预警')) {
                    statusClass = 'bg-yellow-50 text-yellow-600 border-l-4 border-yellow-400';
                } else if (instrument.status.includes('形态预警')) {
                    statusClass = 'bg-purple-50 text-purple-600 border-l-4 border-purple-400';
                } else if (instrument.status) {
                    statusClass = 'bg-blue-50 text-blue-600 border-l-4 border-blue-400';
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${instrument.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${instrument.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" step="0.01" value="${instrument.monitor_price}" 
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                            onchange="updateMonitorPrice(${index}, this.value)">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer price-monitor-toggle" data-index="${index}" ${instrument.priceMonitor ? 'checked' : ''}
                                onchange="togglePriceMonitor(${index}, this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                                onchange="updateAtrDirection(${index}, this.value)">
                            <option value="多" ${instrument.atrDirection === '多' ? 'selected' : ''}>多</option>
                            <option value="空" ${instrument.atrDirection === '空' ? 'selected' : ''}>空</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer atr-monitor-toggle" data-index="${index}" ${instrument.atrMonitor ? 'checked' : ''}
                                onchange="toggleAtrMonitor(${index}, this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                                onchange="updatePatternDirection(${index}, this.value)">
                            <option value="多" ${instrument.patternDirection === '多' ? 'selected' : ''}>多</option>
                            <option value="空" ${instrument.patternDirection === '空' ? 'selected' : ''}>空</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer pattern-monitor-toggle" data-index="${index}" ${instrument.patternMonitor ? 'checked' : ''}
                                onchange="togglePatternMonitor(${index}, this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap ${statusClass}">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-5 w-5 mr-2">
                                ${instrument.status.includes('价格预警') ? '<i class="fa-solid fa-arrow-up text-red-500"></i>' : 
                                  instrument.status.includes('ATR预警') ? '<i class="fa-solid fa-chart-line text-yellow-500"></i>' : 
                                  instrument.status.includes('形态预警') ? '<i class="fa-solid fa-pattern text-purple-500"></i>' : 
                                  instrument.status ? '<i class="fa-solid fa-info-circle text-blue-500"></i>' : ''}
                            </div>
                            <span class="font-medium">${instrument.status || '正常'}</span>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 更新仪表盘统计信息
        function updateDashboardStats() {
            const activeMonitors = instruments.filter(i => 
                i.priceMonitor || i.atrMonitor || i.patternMonitor
            ).length;
            
            const alertCount = instruments.filter(i => i.status).length;
            
            document.getElementById('active-monitors').textContent = activeMonitors;
            document.getElementById('alert-count').textContent = alertCount;
        }
        
        // 更新监测价格
        function updateMonitorPrice(index, price) {
            instruments[index].monitor_price = parseFloat(price);
            
            fetch('/api/update_monitor_price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, price })
            })
            .then(response => response.json())
            .then(data => {
                console.log('监测价格已更新:', data);
            })
            .catch(error => {
                console.error('更新监测价格失败:', error);
            });
        }
        
        // 切换价格监测开关
        function togglePriceMonitor(index, status) {
            instruments[index].priceMonitor = status;
            
            fetch('/api/toggle_price_monitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, status })
            })
            .then(response => response.json())
            .then(data => {
                console.log('价格监测开关已更新:', data);
                updateDashboardStats();
            })
            .catch(error => {
                console.error('更新价格监测开关失败:', error);
            });
        }
        
        // 更新ATR监测方向
        function updateAtrDirection(index, direction) {
            instruments[index].atrDirection = direction;
            
            fetch('/api/update_atr_direction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, direction })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ATR监测方向已更新:', data);
            })
            .catch(error => {
                console.error('更新ATR监测方向失败:', error);
            });
        }
        
        // 切换ATR监测开关
        function toggleAtrMonitor(index, status) {
            instruments[index].atrMonitor = status;
            
            fetch('/api/toggle_atr_monitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, status })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ATR监测开关已更新:', data);
                updateDashboardStats();
            })
            .catch(error => {
                console.error('更新ATR监测开关失败:', error);
            });
        }
        
        // 更新形态监测方向
        function updatePatternDirection(index, direction) {
            instruments[index].patternDirection = direction;
            
            fetch('/api/update_pattern_direction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, direction })
            })
            .then(response => response.json())
            .then(data => {
                console.log('形态监测方向已更新:', data);
            })
            .catch(error => {
                console.error('更新形态监测方向失败:', error);
            });
        }
        
        // 切换形态监测开关
        function togglePatternMonitor(index, status) {
            instruments[index].patternMonitor = status;
            
            fetch('/api/toggle_pattern_monitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index, status })
            })
            .then(response => response.json())
            .then(data => {
                console.log('形态监测开关已更新:', data);
                updateDashboardStats();
            })
            .catch(error => {
                console.error('更新形态监测开关失败:', error);
            });
        }
        
        // 切换所有价格监测开关
        function toggleAllPriceMonitors() {
            const allChecked = instruments.every(i => i.priceMonitor);
            instruments.forEach(i => i.priceMonitor = !allChecked);
            
            // 批量更新
            instruments.forEach((i, index) => {
                fetch('/api/toggle_price_monitor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ index, status: !allChecked })
                });
            });
            
            updateTable();
            updateDashboardStats();
        }
        
        // 切换所有ATR监测开关
        function toggleAllAtrMonitors() {
            const allChecked = instruments.every(i => i.atrMonitor);
            instruments.forEach(i => i.atrMonitor = !allChecked);
            
            // 批量更新
            instruments.forEach((i, index) => {
                fetch('/api/toggle_atr_monitor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ index, status: !allChecked })
                });
            });
            
            updateTable();
            updateDashboardStats();
        }
        
        // 切换所有形态监测开关
        function toggleAllPatternMonitors() {
            const allChecked = instruments.every(i => i.patternMonitor);
            instruments.forEach(i => i.patternMonitor = !allChecked);
            
            // 批量更新
            instruments.forEach((i, index) => {
                fetch('/api/toggle_pattern_monitor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ index, status: !allChecked })
                });
            });
            
            updateTable();
            updateDashboardStats();
        }
        
        // 过滤表格
        function filterTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const rows = document.getElementById('futures-table-body').querySelectorAll('tr');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('showing-range').textContent = `1-${visibleCount}`;
        }
        
        // 初始化图表
        function initCharts() {
            // 预警类型分布图表
            const alertTypesCtx = document.getElementById('alert-types-chart').getContext('2d');
            alertTypesChart = new Chart(alertTypesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['价格预警', 'ATR预警', '形态预警', '其他'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#F53F3F',  // 价格预警 - 红色
                            '#FF7D00',  // ATR预警 - 橙色
                            '#722ED1',  // 形态预警 - 紫色
                            '#165DFF'   // 其他 - 蓝色
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            padding: 10,
                            boxPadding: 5
                        }
                    },
                    cutout: '70%'
                }
            });
            
            // 预警趋势图表
            const alertTrendCtx = document.getElementById('alert-trend-chart').getContext('2d');
            alertTrendChart = new Chart(alertTrendCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `${i+1}时`),
                    datasets: [{
                        label: '预警数量',
                        data: Array(12).fill(0),
                        borderColor: '#165DFF',
                        backgroundColor: 'rgba(22, 93, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // 更新图表
        function updateCharts() {
            // 更新预警类型分布
            const priceAlerts = instruments.filter(i => i.status.includes('价格预警')).length;
            const atrAlerts = instruments.filter(i => i.status.includes('ATR预警')).length;
            const patternAlerts = instruments.filter(i => i.status.includes('形态预警')).length;
            const otherAlerts = instruments.filter(i => i.status && !i.status.includes('价格预警') && !i.status.includes('ATR预警') && !i.status.includes('形态预警')).length;
            
            alertTypesChart.data.datasets[0].data = [priceAlerts, atrAlerts, patternAlerts, otherAlerts];
            alertTypesChart.update();
            
            // 更新预警趋势（模拟数据）
            const now = new Date();
            const currentHour = now.getHours();
            const trendData = Array(12).fill(0);
            
            // 模拟过去12小时的预警数据
            for (let i = 0; i < 12; i++) {
                const hour = (currentHour - i + 24) % 24;
                // 随机生成一些数据
                trendData[i] = Math.floor(Math.random() * 10);
            }
            
            alertTrendChart.data.datasets[0].data = trendData.reverse();
            alertTrendChart.update();
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notificationContainer = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            // 设置通知样式
            let bgColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-50 border-l-4 border-green-400';
                    icon = 'fa-check-circle text-green-500';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50 border-l-4 border-yellow-400';
                    icon = 'fa-exclamation-triangle text-yellow-500';
                    break;
                case 'danger':
                    bgColor = 'bg-red-50 border-l-4 border-red-400';
                    icon = 'fa-exclamation-circle text-red-500';
                    break;
                default:
                    bgColor = 'bg-blue-50 border-l-4 border-blue-400';
                    icon = 'fa-info-circle text-blue-500';
            }
            
            notification.className = `${bgColor} p-4 rounded-lg shadow-lg mb-3 animate-fade-in transform transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa ${icon}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-800">${message}</p>
                    </div>
                    <button class="ml-auto flex-shrink-0 text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            
            // 添加关闭功能
            notification.querySelector('button').addEventListener('click', () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(20px)';
                setTimeout(() => notification.remove(), 300);
            });
            
            // 添加到容器
            notificationContainer.appendChild(notification);
            
            // 自动关闭
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(20px)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // 启动时钟
        function startClock() {
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('current-time').textContent = timeString;
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        // 导航栏滚动效果
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 10) {
                navbar.classList.add('py-2');
                navbar.classList.remove('py-3');
            } else {
                navbar.classList.add('py-3');
                navbar.classList.remove('py-2');
            }
        });
    </script>
</body>
</html>    